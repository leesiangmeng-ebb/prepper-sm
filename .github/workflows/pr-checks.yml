name: PR Checks

on:
  pull_request:
    branches:
      - master

jobs:
  pr-description:
    name: Generate PR Description
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate PR summary
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            // Get the list of commits
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            // Get the list of changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            // Build commit summary
            const commitList = commits.map(c => `- ${c.commit.message.split('\n')[0]}`).join('\n');

            // Categorize changed files
            const backendFiles = files.filter(f => f.filename.startsWith('backend/'));
            const frontendFiles = files.filter(f => f.filename.startsWith('frontend/'));
            const otherFiles = files.filter(f => !f.filename.startsWith('backend/') && !f.filename.startsWith('frontend/'));

            let filesSummary = '';
            if (backendFiles.length > 0) {
              filesSummary += `### Backend (${backendFiles.length} files)\n`;
              filesSummary += backendFiles.map(f => `- \`${f.filename}\` (+${f.additions}/-${f.deletions})`).join('\n');
              filesSummary += '\n\n';
            }
            if (frontendFiles.length > 0) {
              filesSummary += `### Frontend (${frontendFiles.length} files)\n`;
              filesSummary += frontendFiles.map(f => `- \`${f.filename}\` (+${f.additions}/-${f.deletions})`).join('\n');
              filesSummary += '\n\n';
            }
            if (otherFiles.length > 0) {
              filesSummary += `### Other (${otherFiles.length} files)\n`;
              filesSummary += otherFiles.map(f => `- \`${f.filename}\` (+${f.additions}/-${f.deletions})`).join('\n');
              filesSummary += '\n\n';
            }

            // Build the comment body
            const body = `## PR Summary

            ### Commits (${commits.length})
            ${commitList}

            ## Changed Files (${files.length} total)
            ${filesSummary}
            ---
            *This summary was auto-generated by GitHub Actions*`;

            // Check if we already have a comment from this action
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('This summary was auto-generated by GitHub Actions')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }
